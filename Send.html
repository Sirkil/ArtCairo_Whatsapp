<!DOCTYPE html>
<html>
<head>
    <title>WhatsApp Sender</title>
    <style>
        body { font-family: sans-serif; padding: 40px; background: #f0f2f5; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 150px; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; }
        button { width: 100%; padding: 15px; background: #25D366; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        #status { margin-top: 20px; font-size: 14px; color: #555; height: 150px; overflow-y: auto; background: #fafafa; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>WhatsApp Bulk UI</h2>
    <p>Enter phone numbers (one per line):</p>
    <textarea id="numbersInput" placeholder="201012345678"></textarea>
    <button id="sendBtn">Send Messages & Log</button>
    <div id="status"></div>
</div>

<script src="config.js"></script>
<script src="bulkSend.js"></script>


<script>
    // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-R7W2RTDO0qL2Yp4f8rgisDL8zcJwN8sZN4QfAffaH5Qzwalfhj-Oe_gwm6DpNLEK/exec";

    document.getElementById('sendBtn').onclick = async function() {
    const input = document.getElementById('numbersInput').value;
    const numbers = input.split('\n').map(n => n.trim()).filter(n => n !== "");
    const statusDiv = document.getElementById('status');
    const btn = this;

    if(numbers.length === 0) return alert("Please enter numbers");

    btn.disabled = true;
    statusDiv.innerHTML = "<b>Starting Process...</b><br>";

    for (let phone of numbers) {
        statusDiv.innerHTML += `Sending to ${phone}... `;
        
        // 1. Call your function from bulkSend.js
        const result = await sendWhatsAppTemplate(phone);
        
        // 2. Parse the specific message status from the response body
        let whatsappMessageStatus = "N/A";
        if (result.success && result.details.messages && result.details.messages[0]) {
            // This extracts "accepted" from the WhatsApp JSON
            whatsappMessageStatus = result.details.messages[0].message_status;
        } else if (!result.success) {
            whatsappMessageStatus = result.details; // Stores the error message
        }

        // 3. Update UI
        if(result.success) {
            statusDiv.innerHTML += `<span style="color:green">Success (${whatsappMessageStatus})</span><br>`;
        } else {
            statusDiv.innerHTML += `<span style="color:red">Error: ${whatsappMessageStatus}</span><br>`;
        }

        // 4. Send clean data to Google Sheets
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                cache: 'no-cache',
                body: JSON.stringify({
                    phone: phone,
                    status: result.success ? "Sent" : "Failed",
                    wa_status: whatsappMessageStatus, // Only the status string (e.g. "accepted")
                    sender: SENDER_NUMBER
                })
            });
        } catch (e) {
            console.error("Sheets Logging Failed", e);
        }
    }

    statusDiv.innerHTML += "<b>Done! Check your Google Sheet.</b>";
    btn.disabled = false;
};
</script>

</body>
</html>